name: CPA Funnel Automation Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Run every 6 hours

jobs:
  funnel-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - - name: Install dependencies
  run: |
    echo "ğŸ“¦ Installing dependencies with rebrowser patches..."
    npm install
    echo "ğŸ­ Installing Rebrowser Playwright with Chromium..."
    npx rebrowser-playwright install --with-deps chromium
    
    - name: Validate files
      run: |
        echo "ğŸ“ Checking configuration files..."
        if [ ! -f "wfh_localjobmatcher.json" ]; then
          echo "âŒ Config file not found!"
          exit 1
        fi
        echo "âœ… Config file found"
        
        echo "ğŸ“ Checking user data..."
        if [ ! -f "User-Data.csv" ]; then
          echo "âŒ User data not found!"
          exit 1
        fi
        echo "âœ… User data found"
        
    - name: Run CPA Funnel Tests
      env:
        BROWSER: chromium
        HEADLESS: true  # Must be true for GitHub Actions
        CI: true
        USE_DEFAULT_PROXY: true
      run: |
        echo "ğŸ§ª Starting funnel test with chromium"
        timeout 300 node test-funnel.js || echo "Test completed or timed out"
    
    - name: Upload results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ github.run_number }}
        path: |
          *test-results*.json
          failure-*.png
        retention-days: 30
